{{- if .Values.admissionController.enabled }}
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{ include "admissionController.resourceNamePrefix" . }}-vwc
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "-5"
---
{{ $tls := include "admissionController.tls" . | fromYaml }}
{{- if or .Values.admissionController.caCertificate.createSelfSigned .Values.admissionController.caCertificate.embeddedTls }}
apiVersion: v1
kind: Secret 
type: kubernetes.io/tls
metadata:
  annotations:
    {{- include "annotations" . | nindent 4 }}
  labels:
    {{- include "labels" . | nindent 4 }}
    {{- include "admissionController.labels" . | nindent 4 }}
  name: {{ include "admissionController.caCertificateSecretName" . }}
  namespace: {{ .Release.Namespace }}
data:
  tls.crt: {{ $tls.serverCertificateBase64 }}
  tls.key: {{ $tls.serverCertificateKeyBase64 }}
{{- end }}
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  annotations:
    {{- include "annotations" . | nindent 4 }}
    {{- with .Values.admissionController.webhook.annotations }}
      {{- toYaml . | nindent 4 }}
    {{- end }}}}
  labels:
    {{- include "labels" . | nindent 4 }}
    {{- include "admissionController.labels" . | nindent 4 }}
  name: {{ include "admissionController.resourceNamePrefix" . }}-vwc
webhooks:
- admissionReviewVersions:
  - v1
  - v1beta1
  clientConfig:
    {{- if not .Values.admissionController.caCertificate.injectExternally }}
    caBundle: {{ $tls.serverCertificateAuthorityCertificateBase64 }}
    {{- end }}
    service:
      name: {{ include "admissionController.resourceNamePrefix" . }}-service
      namespace: {{ .Release.Namespace }}
      path: /v1/admit
      port: 443
  failurePolicy: {{ .Values.admissionController.webhook.failurePolicy }}
  matchPolicy: Exact
  name: validation.tenable.com
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ .Release.Namespace }}
  sideEffects: None
  timeoutSeconds: {{ .Values.admissionController.webhook.timeoutSeconds }}
{{- end }}